#!/usr/bin/env bash
# test-gate-repair-loop.sh — Integration test for the REPAIR loop
# Creates a test document with a missing AGENT-CONTEXT field, runs quality-gates.sh,
# simulates REPAIR by fixing the issue, and verifies the gate passes within ≤3 iterations.
#
# Usage: test-gate-repair-loop.sh [--json] [--verbose]
#
# Exit codes:
#   0 = REPAIR loop test passes
#   1 = Test failed
#   2 = Configuration error

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JSON_OUTPUT=false
VERBOSE=false

for arg in "$@"; do
  case "$arg" in
    --json) JSON_OUTPUT=true ;;
    --verbose) VERBOSE=true ;;
  esac
done

# ── Create test document with MISSING required field (version) ──
test_doc=$(mktemp /tmp/repair-test-XXXXXX.md)
cat > "$test_doc" << 'TESTEOF'
# Test Module

> Generated by Ground Truth v1.0.0 | 2026-01-01

<!-- AGENT-CONTEXT: name=test-module, type=module, purpose=Test module for repair loop, key_files=README.md -->

## Purpose

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=test -->
This module does testing things. See `README.md:1`.

<!-- ground-truth-meta: head_sha=abc123 generated_at=2026-01-01 features_sha=abc limitations_sha=abc ride_sha=abc -->
TESTEOF

log() {
  if $VERBOSE; then echo "  $1"; fi
}

log "Created test document with missing 'version' field in AGENT-CONTEXT"

# ── Iteration 1: Run quality gates — should fail on check-agent-context ──
iteration=1
max_iterations=3
repaired=false

while [[ $iteration -le $max_iterations ]]; do
  log "Iteration $iteration/$max_iterations: Running quality-gates.sh..."

  gate_exit=0
  gate_output=$("$SCRIPT_DIR/quality-gates.sh" "$test_doc" --json 2>/dev/null) || gate_exit=$?

  passed=$(echo "$gate_output" | jq -r '.passed // false' 2>/dev/null || echo "false")

  if [[ "$passed" == "true" ]]; then
    log "Iteration $iteration: All gates PASSED"
    repaired=true
    break
  fi

  log "Iteration $iteration: Gates failed (exit=$gate_exit)"

  # ── Simulate REPAIR: parse violations and fix them ──
  violations=$(echo "$gate_output" | jq -r '.violations[]?.message // empty' 2>/dev/null || true)
  gate_failures=$(echo "$gate_output" | jq -r '.blocking_gates[]? | select(.status == "fail") | .gate' 2>/dev/null || true)

  log "Failed gates: $gate_failures"

  # Fix: Add missing version field to AGENT-CONTEXT
  if echo "$gate_failures" | grep -q "check-agent-context"; then
    current_sha=$(git rev-parse HEAD 2>/dev/null || echo "0000000000000000000000000000000000000000")
    sed -i "s|key_files=README.md -->|key_files=README.md, version=$current_sha -->|" "$test_doc"
    log "REPAIR: Added missing 'version' field to AGENT-CONTEXT"
  fi

  # Fix: If verify-citations fails, remove the evidence anchor that can't be verified
  if echo "$gate_failures" | grep -q "verify-citations"; then
    sed -i 's/<!-- evidence: symbol=test -->//' "$test_doc"
    log "REPAIR: Removed unverifiable evidence anchor"
  fi

  # Fix: If check-links fails, no broken links to fix in test doc (pass-through)
  if echo "$gate_failures" | grep -q "check-links"; then
    log "REPAIR: check-links issue (no relative links in test doc, may be script error)"
  fi

  ((iteration++)) || true
done

# Cleanup
rm -f "$test_doc"

# ── Output ──
if $repaired; then
  if $JSON_OUTPUT; then
    echo '{"passed":true,"iterations":'"$iteration"',"max_iterations":'"$max_iterations"',"message":"REPAIR loop fixed missing AGENT-CONTEXT field"}'
  else
    echo "PASS: REPAIR loop converged in $iteration iteration(s) (max: $max_iterations)"
  fi
  exit 0
else
  if $JSON_OUTPUT; then
    echo '{"passed":false,"iterations":'"$max_iterations"',"max_iterations":'"$max_iterations"',"message":"REPAIR loop did not converge within '"$max_iterations"' iterations"}'
  else
    echo "FAIL: REPAIR loop did not converge within $max_iterations iterations"
  fi
  exit 1
fi
