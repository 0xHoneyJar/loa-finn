---
title: loa-finn — Architecture Overview
version: 1.0.0
---

# loa-finn — Architecture Overview

> Generated by Ground Truth v1.0.0
> Grounded in: features.yaml + codebase analysis


## System Overview

<!-- provenance: REPO-DOC-GROUNDED -->
loa-finn is a persistent autonomous agent server organized into five architecture layers with unidirectional dependencies. See `grimoires/loa/sdd-ground-truth.md §3` for the full component design. Each layer operates independently, communicating through typed interfaces exported from barrel modules.

<!-- provenance: ANALOGY -->
The layered composition follows the same separation of concerns as the Linux kernel — a stable persistence layer at the bottom (analogous to the VFS and block layer), orchestration and scheduling in the middle (analogous to the process scheduler), and a gateway at the top that accepts external requests (analogous to the syscall interface). Dependencies flow strictly downward.


## Architecture Layers

### Layer 1: Persistence

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=WALManager, symbol=createWALManager, symbol=GitSync, symbol=ObjectStoreSync, symbol=WALPruner -->
The persistence barrel at `src/persistence/index.ts:1-30` exports five durability primitives. `WALManager` and its `createWALManager` factory provide append-only write-ahead logging with crash recovery. `GitSync` snapshots state to git repositories, `ObjectStoreSync` replicates to Cloudflare R2, and `WALPruner` compacts old segments. Together these form a recovery cascade where state can be restored from any available source.

<!-- provenance: ANALOGY -->
This multi-source durability mirrors PostgreSQL's WAL architecture — append-only writes ensure no partial pages reach disk. The recovery cascade adds a Bigtable-style redundancy layer where both local (git) and remote (R2) checkpoints serve as independent recovery sources.


### Layer 2: Orchestration

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=HounfourRouterOptions, symbol=ProviderRegistry, symbol=BudgetEnforcer, symbol=PoolRegistry -->
The orchestration layer centers on `src/hounfour/router.ts:38-50` where `HounfourRouterOptions` defines the composition root. It accepts a `ProviderRegistry` for model adapters, a `BudgetEnforcer` for cost control, a health prober, and an optional `PoolRegistry` for tier-based routing. Pool definitions map pool IDs to provider/model configurations with tier access controls, ensuring JWT claims never contain raw model names.

<!-- provenance: ANALOGY -->
The pool registry and routing system functions like Kubernetes Service Discovery — pool IDs serve as service names, and the router resolves them to concrete provider endpoints with health-aware failover.


### Layer 3: Agent & Safety

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=PoolErrorCode, symbol=PoolError -->
The agent safety layer at `src/agent/worker-pool.ts:17-32` implements priority-lane execution with typed error codes. `PoolErrorCode` defines five failure modes with explicit retry semantics: WORKER_UNAVAILABLE (backoff), POOL_SHUTTING_DOWN (no retry), SANDBOX_DISABLED, EXEC_TIMEOUT (retry once), and WORKER_CRASHED (auto-recovered). The `PoolError` class wraps each code for structured error handling, and the ExecSpec interface requires validated binary paths and sanitized argument arrays.

<!-- provenance: ANALOGY -->
The sandbox execution model follows the same isolation pattern as Chrome's multi-process architecture — each tool invocation runs in a separate worker thread with enforced timeouts and resource limits, preventing a single runaway operation from affecting the host process.


### Layer 4: Application Services

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=CronService, symbol=CircuitBreaker, symbol=computeNextRunAtMs -->
The scheduling service at `src/cron/service.ts:1-8` provides `CronService` with tick-based job execution and stuck-job detection. Per-job `CircuitBreaker` isolation implements a three-state machine (closed, open, half_open) with five failure classes. The `computeNextRunAtMs` function handles cron expression parsing for next-run scheduling.

<!-- provenance: REPO-DOC-GROUNDED -->
Two additional application services operate at this layer. The BridgeBuilder review pipeline (see `grimoires/loa/sdd-ground-truth.md §3`) composes configuration loading, adapter creation, and sanitized logging into a multi-step PR review system. The compound learning system captures session trajectories and extracts candidate learnings with trigger, context, resolution, and confidence scoring.

<!-- provenance: ANALOGY -->
The scheduling framework mirrors Apache Airflow's DAG scheduler — declarative job registration with dependency-aware execution and idempotency guards preventing duplicate runs on retry.


### Layer 5: Gateway

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=createApp, symbol=AppOptions, symbol=S2SJwtSigner -->
The HTTP gateway at `src/gateway/server.ts:19-30` uses Hono as its framework. The `createApp` function accepts `AppOptions` with optional dependencies: HealthAggregator, ActivityFeed, SandboxExecutor, WorkerPool, HounfourRouter, and `S2SJwtSigner` for JWT-authenticated service-to-service endpoints. JWT validation uses ES256 with remote JWKS rotation to extract tenant context from incoming requests.

<!-- provenance: ANALOGY -->
The gateway composition mirrors how Vercel's edge runtime wires middleware — authentication, rate limiting, CORS, and routing are composed as independent middleware layers, each injectable and testable in isolation.


## Component Interactions

<!-- provenance: CODE-FACTUAL -->
<!-- evidence: symbol=AppOptions, symbol=HounfourRouter, symbol=WorkerPool -->
The gateway's `AppOptions` at `src/gateway/server.ts:19-27` serves as the top-level wiring point. Each optional dependency represents a cross-layer integration: `HounfourRouter` connects to orchestration, `WorkerPool` connects to agent safety, HealthAggregator connects to scheduling health, and S2SJwtSigner enables authenticated inter-service calls.

```
Gateway (Hono + JWT)
  ├── Orchestration (HounfourRouter → PoolRegistry → ProviderRegistry)
  │     └── Budget (BudgetEnforcer → scope-key derivation)
  ├── Agent Safety (WorkerPool → SandboxExecutor)
  ├── Application Services
  │     ├── CronService → CircuitBreaker
  │     ├── BridgeBuilder → PR Review Pipeline
  │     └── CompoundLearning → TrajectoryEntry → CandidateLearning
  └── Persistence (WALManager → GitSync + R2Sync + Pruner)
```

<!-- provenance: ANALOGY -->
This dependency graph follows the same inversion-of-control pattern Kubernetes uses with its API server — the gateway accepts pluggable backends via interface injection, allowing any layer to be replaced or disabled without modifying the gateway code.


## Design Principles

<!-- provenance: REPO-DOC-GROUNDED -->
The architecture follows three core principles documented in `grimoires/loa/sdd-ground-truth.md §3`: deterministic verification (shell scripts only in the verification path), human-curated registries (features.yaml is never auto-generated), and fail-fast validation (PATH_SAFETY runs before any file I/O).

<!-- provenance: ANALOGY -->
These principles reflect the same philosophy behind HashiCorp's Sentinel policy framework — automated enforcement of human-authored rules, where the policy engine is deterministic but the policies themselves encode human judgment about what constitutes acceptable behavior.


## What This Architecture Enables

<!-- provenance: ANALOGY -->
The five-layer architecture enables independent evolution of each concern — persistence can adopt CRDTs without touching the gateway, orchestration can add providers without modifying scheduling, and the agent safety boundary protects the host regardless of what application services execute. This is the same composability that makes Kubernetes extensible: a stable core with pluggable controllers, each operating within well-defined interfaces.

<!-- ground-truth-meta: head_sha=c38e15dccc03def2570c48fb1215dea3bdb866c7 generated_at=2026-02-10T09:49:29Z features_sha=9cf7d7638dc91671ccb4b2c72bd1bcd2aa0d2dfb limitations_sha=e5c7ffff6e5bdbff142b490a20f612f9165aeec8 ride_sha=none -->
